name: Deploy Database Migrations

on:
  push:
    branches:
      - main
    paths:
      - 'supabase/migrations/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  validate-migrations:
    name: Validate Migrations
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate migration files
        working-directory: supabase/migrations
        run: |
          echo "Validating migration files..."
          error_count=0

          # Check for .sql files
          if ! ls *.sql >/dev/null 2>&1; then
            echo "❌ No migration files found"
            exit 1
          fi

          # Check file naming convention (NNNN_name.sql)
          for file in *.sql; do
            if [[ ! $file =~ ^[0-9]{4}_.+\.sql$ ]]; then
              echo "❌ Invalid migration filename: $file (should be NNNN_name.sql)"
              error_count=$((error_count + 1))
            else
              echo "✅ Valid migration file: $file"
            fi
          done

          if [ $error_count -gt 0 ]; then
            echo "Found $error_count validation errors"
            exit 1
          fi

          echo "All migration files are valid"

      - name: Check for SQL syntax errors (basic)
        working-directory: supabase/migrations
        run: |
          echo "Checking for common SQL syntax errors..."
          for file in *.sql; do
            echo "Checking $file..."

            # Check for unmatched parentheses
            open_parens=$(grep -o '(' "$file" | wc -l)
            close_parens=$(grep -o ')' "$file" | wc -l)
            if [ $open_parens -ne $close_parens ]; then
              echo "⚠️  Warning: Unmatched parentheses in $file (open: $open_parens, close: $close_parens)"
            fi

            # Check for common typos
            if grep -qi "CRATE TABLE" "$file"; then
              echo "❌ Found typo 'CRATE TABLE' (should be 'CREATE TABLE') in $file"
              exit 1
            fi
          done

          echo "Basic SQL syntax checks passed"

  deploy-migrations:
    name: Deploy to Supabase
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: validate-migrations
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Verify Supabase CLI
        run: supabase --version

      - name: Link to Supabase project
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
        run: |
          if [ -z "$SUPABASE_ACCESS_TOKEN" ] || [ -z "$SUPABASE_PROJECT_ID" ]; then
            echo "⚠️  Supabase secrets not configured - skipping deployment"
            echo "Please set SUPABASE_ACCESS_TOKEN and SUPABASE_PROJECT_ID in repository secrets"
            exit 0
          fi

          echo "Linking to Supabase project..."
          supabase link --project-ref $SUPABASE_PROJECT_ID

      - name: Run database migrations
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
        run: |
          if [ -z "$SUPABASE_ACCESS_TOKEN" ]; then
            echo "Skipping migration deployment - secrets not configured"
            exit 0
          fi

          echo "Deploying database migrations..."
          supabase db push || {
            echo "❌ Migration deployment failed"
            exit 1
          }

          echo "✅ Migrations deployed successfully"

      - name: Verify migration status
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          if [ -z "$SUPABASE_ACCESS_TOKEN" ]; then
            echo "Skipping migration verification - secrets not configured"
            exit 0
          fi

          echo "Verifying migration status..."
          supabase migration list || echo "Could not list migrations"

  notify-deployment:
    name: Notify Deployment
    runs-on: ubuntu-latest
    needs: deploy-migrations
    if: always() && (github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch')

    steps:
      - name: Deployment status
        run: |
          if [ "${{ needs.deploy-migrations.result }}" == "success" ]; then
            echo "✅ Database migrations deployed successfully"
          elif [ "${{ needs.deploy-migrations.result }}" == "skipped" ]; then
            echo "⏭️  Migration deployment skipped (secrets not configured)"
          else
            echo "❌ Migration deployment failed"
            exit 1
          fi
